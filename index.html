<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tesla Model Y Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              tesla: {
                black: '#000000',
                panel: '#121212',
                panelSoft: '#1d1d1d',
                stroke: '#2a2a2a',
                text: '#ffffff',
                muted: '#a1a1aa',
                accent: '#4f46e5'
              }
            }
          }
        }
      };
    </script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #000;
        color: #fff;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      .tesla-scroll::-webkit-scrollbar {
        width: 10px;
      }
      .tesla-scroll::-webkit-scrollbar-thumb {
        background: #2a2a2a;
        border-radius: 999px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const ICONS = {
        mapa: 'üó∫Ô∏è',
        musica: 'üéµ',
        apps: 'üì±',
        ajustes: '‚öôÔ∏è'
      };

      const DEFAULT_SETTINGS = {
        mapboxToken: '',
        weatherApiKey: '',
        weatherCity: 'Madrid'
      };

      function useClock() {
        const [now, setNow] = useState(new Date());
        useEffect(() => {
          const id = setInterval(() => setNow(new Date()), 1000);
          return () => clearInterval(id);
        }, []);
        return now;
      }

      function Sidebar({ section, setSection }) {
        const items = [
          { key: 'mapa', label: 'Mapa' },
          { key: 'musica', label: 'M√∫sica' },
          { key: 'apps', label: 'Apps' },
          { key: 'ajustes', label: 'Ajustes' }
        ];

        return (
          <aside className="w-[120px] bg-tesla-panel border-r border-tesla-stroke flex flex-col items-center py-6 gap-5">
            {items.map((item) => {
              const active = item.key === section;
              return (
                <button
                  key={item.key}
                  onClick={() => setSection(item.key)}
                  className={`w-20 h-20 rounded-full border-2 text-3xl transition-all duration-200 flex items-center justify-center
                    ${
                      active
                        ? 'bg-white text-black border-white shadow-[0_0_30px_rgba(255,255,255,0.3)]'
                        : 'bg-tesla-panelSoft border-tesla-stroke hover:border-white hover:bg-zinc-700'
                    }`}
                  aria-label={item.label}
                  title={item.label}
                >
                  {ICONS[item.key]}
                </button>
              );
            })}
          </aside>
        );
      }

      function NavigationView({ settings }) {
        const mapRef = useRef(null);
        const mapInstanceRef = useRef(null);
        const markerRef = useRef(null);
        const [query, setQuery] = useState('');
        const [status, setStatus] = useState('Esperando ubicaci√≥n...');

        useEffect(() => {
          if (!settings.mapboxToken || !window.mapboxgl) return;
          if (mapInstanceRef.current) return;

          mapboxgl.accessToken = settings.mapboxToken;
          const map = new mapboxgl.Map({
            container: mapRef.current,
            style: 'mapbox://styles/mapbox/dark-v11',
            zoom: 13,
            center: [-3.7038, 40.4168]
          });

          map.addControl(new mapboxgl.NavigationControl(), 'top-right');
          mapInstanceRef.current = map;

          if ('geolocation' in navigator) {
            const watchId = navigator.geolocation.watchPosition(
              (position) => {
                const coords = [position.coords.longitude, position.coords.latitude];
                if (!markerRef.current) {
                  markerRef.current = new mapboxgl.Marker({ color: '#22c55e' })
                    .setLngLat(coords)
                    .addTo(map);
                } else {
                  markerRef.current.setLngLat(coords);
                }
                map.easeTo({ center: coords, duration: 800 });
                setStatus('GPS conectado en tiempo real');
              },
              () => setStatus('No se pudo acceder a la geolocalizaci√≥n.'),
              { enableHighAccuracy: true, maximumAge: 5000 }
            );

            return () => navigator.geolocation.clearWatch(watchId);
          }
        }, [settings.mapboxToken]);

        const searchDestination = async (event) => {
          event.preventDefault();
          if (!query.trim() || !settings.mapboxToken || !mapInstanceRef.current) return;
          try {
            const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
              query
            )}.json?limit=1&access_token=${settings.mapboxToken}`;
            const response = await fetch(endpoint);
            const data = await response.json();
            if (!data.features?.length) {
              setStatus('Destino no encontrado.');
              return;
            }
            const [lng, lat] = data.features[0].center;
            mapInstanceRef.current.flyTo({ center: [lng, lat], zoom: 14 });
            setStatus(`Destino: ${data.features[0].place_name}`);
          } catch {
            setStatus('Error consultando destino.');
          }
        };

        if (!settings.mapboxToken) {
          return (
            <div className="h-full flex items-center justify-center text-center p-8">
              <div className="bg-tesla-panel rounded-2xl border border-tesla-stroke p-6 max-w-xl">
                <h2 className="text-3xl font-semibold mb-3">Navegaci√≥n bloqueada</h2>
                <p className="text-tesla-muted">
                  Configura tu token de Mapbox en Ajustes para habilitar el mapa interactivo y la geolocalizaci√≥n.
                </p>
              </div>
            </div>
          );
        }

        return (
          <div className="h-full flex flex-col">
            <form onSubmit={searchDestination} className="p-4 border-b border-tesla-stroke bg-black/80 flex gap-3">
              <input
                className="flex-1 rounded-xl px-4 py-3 bg-tesla-panel border border-tesla-stroke text-white text-xl focus:outline-none focus:border-white"
                placeholder="Buscar destino (ej. Supercargador Barcelona)"
                value={query}
                onChange={(e) => setQuery(e.target.value)}
              />
              <button
                className="px-8 py-3 rounded-xl bg-white text-black text-xl font-semibold hover:bg-zinc-200 active:scale-95"
                type="submit"
              >
                Ir
              </button>
            </form>
            <div className="px-4 py-2 text-sm text-tesla-muted border-b border-tesla-stroke">{status}</div>
            <div className="flex-1" ref={mapRef} id="map"></div>
          </div>
        );
      }

      function MusicView() {
        const services = [
          {
            name: 'Spotify',
            logo: 'https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg',
            url: 'https://open.spotify.com'
          },
          {
            name: 'YouTube Music',
            logo: 'https://upload.wikimedia.org/wikipedia/commons/d/d8/YouTubeMusic_Logo.png',
            url: 'https://music.youtube.com'
          },
          {
            name: 'Tidal',
            logo: 'https://upload.wikimedia.org/wikipedia/commons/9/95/Tidal_logo.svg',
            url: 'https://listen.tidal.com'
          }
        ];

        const [activeUrl, setActiveUrl] = useState('https://open.spotify.com');

        return (
          <div className="h-full grid grid-cols-12 gap-4 p-4">
            <div className="col-span-4 bg-tesla-panel rounded-2xl border border-tesla-stroke p-4 space-y-4 tesla-scroll overflow-auto">
              <h2 className="text-3xl font-semibold">Multimedia</h2>
              {services.map((service) => (
                <button
                  key={service.name}
                  onClick={() => setActiveUrl(service.url)}
                  className={`w-full rounded-2xl border p-4 flex items-center gap-4 transition
                    ${activeUrl === service.url ? 'border-white bg-zinc-800' : 'border-tesla-stroke bg-black hover:border-white'}`}
                >
                  <img src={service.logo} alt={service.name} className="w-14 h-14 rounded-xl bg-white object-contain p-1" />
                  <div className="text-left">
                    <div className="text-2xl font-medium">{service.name}</div>
                    <div className="text-sm text-tesla-muted">Abrir versi√≥n web</div>
                  </div>
                </button>
              ))}
            </div>
            <div className="col-span-8 bg-tesla-panel rounded-2xl border border-tesla-stroke overflow-hidden">
              <iframe
                title="Reproductor Web"
                src={activeUrl}
                className="w-full h-full bg-black"
                referrerPolicy="strict-origin-when-cross-origin"
              />
            </div>
          </div>
        );
      }

      function AppsView({ settings }) {
        const now = useClock();
        const [weather, setWeather] = useState(null);
        const [weatherStatus, setWeatherStatus] = useState('Cargando clima...');

        useEffect(() => {
          const getWeather = async () => {
            if (!settings.weatherApiKey) {
              setWeatherStatus('A√±ade API Key de OpenWeather en Ajustes.');
              return;
            }
            try {
              const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(
                settings.weatherCity || 'Madrid'
              )}&appid=${settings.weatherApiKey}&units=metric&lang=es`;
              const response = await fetch(url);
              if (!response.ok) throw new Error('weather');
              const data = await response.json();
              setWeather(data);
              setWeatherStatus('Actualizado');
            } catch {
              setWeatherStatus('No se pudo obtener el clima.');
            }
          };

          getWeather();
          const refreshId = setInterval(getWeather, 600000);
          return () => clearInterval(refreshId);
        }, [settings.weatherApiKey, settings.weatherCity]);

        const time = useMemo(
          () => now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
          [now]
        );
        const date = useMemo(
          () =>
            now.toLocaleDateString('es-ES', {
              weekday: 'long',
              day: 'numeric',
              month: 'long',
              year: 'numeric'
            }),
          [now]
        );

        return (
          <div className="h-full p-6 grid grid-cols-12 gap-6">
            <div className="col-span-7 rounded-3xl bg-tesla-panel border border-tesla-stroke p-8 flex flex-col justify-center">
              <p className="text-tesla-muted uppercase tracking-[0.2em] text-sm">Hora local</p>
              <h2 className="text-[140px] leading-none font-semibold">{time}</h2>
              <p className="text-3xl text-zinc-300 capitalize">{date}</p>
            </div>

            <div className="col-span-5 space-y-6">
              <div className="rounded-3xl bg-tesla-panel border border-tesla-stroke p-6">
                <h3 className="text-2xl font-semibold mb-4">Clima</h3>
                {weather ? (
                  <div className="space-y-1">
                    <p className="text-5xl font-semibold">{Math.round(weather.main.temp)}¬∞C</p>
                    <p className="text-xl text-zinc-300 capitalize">{weather.weather[0].description}</p>
                    <p className="text-sm text-tesla-muted">{weather.name} ¬∑ {weatherStatus}</p>
                  </div>
                ) : (
                  <p className="text-tesla-muted">{weatherStatus}</p>
                )}
              </div>
              <div className="rounded-3xl bg-tesla-panel border border-tesla-stroke p-6">
                <h3 className="text-2xl font-semibold mb-3">Apps r√°pidas</h3>
                <div className="flex gap-3">
                  <a className="flex-1 text-center rounded-xl bg-black border border-tesla-stroke py-4 hover:border-white" href="https://calendar.google.com" target="_self">Calendar</a>
                  <a className="flex-1 text-center rounded-xl bg-black border border-tesla-stroke py-4 hover:border-white" href="https://mail.google.com" target="_self">Mail</a>
                  <a className="flex-1 text-center rounded-xl bg-black border border-tesla-stroke py-4 hover:border-white" href="https://www.tesla.com/charging" target="_self">Charging</a>
                </div>
              </div>
            </div>
          </div>
        );
      }

      function SettingsView({ settings, setSettings }) {
        const [local, setLocal] = useState(settings);

        useEffect(() => setLocal(settings), [settings]);

        const save = (event) => {
          event.preventDefault();
          setSettings(local);
          localStorage.setItem('tesla-hub-settings', JSON.stringify(local));
        };

        return (
          <div className="h-full flex items-center justify-center p-8">
            <form onSubmit={save} className="w-full max-w-2xl bg-tesla-panel border border-tesla-stroke rounded-3xl p-8 space-y-6">
              <h2 className="text-4xl font-semibold">Ajustes</h2>
              <label className="block">
                <span className="text-lg text-zinc-300">Mapbox Public Token</span>
                <input
                  className="mt-2 w-full rounded-xl px-4 py-3 bg-black border border-tesla-stroke focus:border-white outline-none"
                  value={local.mapboxToken}
                  onChange={(e) => setLocal({ ...local, mapboxToken: e.target.value })}
                  placeholder="pk.ey..."
                />
              </label>
              <label className="block">
                <span className="text-lg text-zinc-300">OpenWeather API Key</span>
                <input
                  className="mt-2 w-full rounded-xl px-4 py-3 bg-black border border-tesla-stroke focus:border-white outline-none"
                  value={local.weatherApiKey}
                  onChange={(e) => setLocal({ ...local, weatherApiKey: e.target.value })}
                  placeholder="Tu API Key"
                />
              </label>
              <label className="block">
                <span className="text-lg text-zinc-300">Ciudad del clima</span>
                <input
                  className="mt-2 w-full rounded-xl px-4 py-3 bg-black border border-tesla-stroke focus:border-white outline-none"
                  value={local.weatherCity}
                  onChange={(e) => setLocal({ ...local, weatherCity: e.target.value })}
                  placeholder="Madrid"
                />
              </label>
              <button className="w-full py-4 rounded-xl bg-white text-black text-xl font-semibold hover:bg-zinc-300 active:scale-[0.99]">
                Guardar configuraci√≥n
              </button>
            </form>
          </div>
        );
      }

      function App() {
        const [section, setSection] = useState('mapa');
        const [settings, setSettings] = useState(() => {
          const saved = localStorage.getItem('tesla-hub-settings');
          if (!saved) return DEFAULT_SETTINGS;
          try {
            return { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
          } catch {
            return DEFAULT_SETTINGS;
          }
        });

        const content = {
          mapa: <NavigationView settings={settings} />,
          musica: <MusicView />,
          apps: <AppsView settings={settings} />,
          ajustes: <SettingsView settings={settings} setSettings={setSettings} />
        };

        return (
          <main className="h-screen w-screen bg-tesla-black text-tesla-text flex overflow-hidden" style={{ minWidth: '1600px' }}>
            <Sidebar section={section} setSection={setSection} />
            <section className="flex-1">{content[section]}</section>
          </main>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
